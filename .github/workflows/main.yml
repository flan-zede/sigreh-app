on: 
  push:  
    branches:  
      - master

  workflow_dispatch:

jobs:  
  build:  
    runs-on: ubuntu-latest  
    steps:
      - name: Checkout source code  
        uses: actions/checkout@v2
      - name: Use Node.js  
        uses: actions/setup-node@v1  
        with:  
          node-version: '14.x'
      - name: Cache Node.js modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.OS }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.OS }}-node-
            ${{ runner.OS }}-
      - name: Install dependencies  
        run: npm ci
      - name: Lint  
        run: npm run lint
      - name: Unit tests  
        run: npm run test:ci  
      - name: E2E  
        run: npm run e2e:ci
      - name: Build app  
        run: npm run build:prod
      - name: Inject slug/short variables  
        uses: rlespinasse/github-slug-action@v2.x
      - name: Upload artifact
        if: success()  
        uses: actions/upload-artifact@v2  
        with:  
          name: ${{ env.GITHUB_REF_SLUG }}-${{ github.run_id }}-${{ github.run_number }}  
          path: ./dist/sigreh

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Inject slug/short variables
        uses: rlespinasse/github-slug-action@v2.x
      - name: Download artefact
        uses: actions/download-artifact@v1
        with:
          name: ${{ env.GITHUB_REF_SLUG }}-${{ github.run_id }}-${{ github.run_number }}
      - name: Deploy to Netlify  
        uses: nwtgck/actions-netlify@v1.1  
        with:  
          publish-dir: ${{ env.GITHUB_REF_SLUG }}-${{ github.run_id }}-${{ github.run_number }}/dist/sigreh  
          production-branch: master  
          github-token: ${{ secrets.GITHUB_TOKEN }}  
          deploy-message: "Deploy from GitHub Actions"  
          enable-pull-request-comment: true  
          enable-commit-comment: true  
          overwrites-pull-request-comment: true  
        env:  
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}  
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}